<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Manajemen Produk Kopi — Terpadu</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* ===== Umum ===== */
    :root{
      --brown1:#3e2723;
      --brown2:#6d4c41;
      --accent:#d7b899;
    }
    *{box-sizing:border-box;font-family: 'Segoe UI', sans-serif; }
    body{
      margin:0;
      min-height:100vh;
      transition: background 0.4s;
    }

    /* ===== Halaman Utama (form & daftar) — Tema cokelat kopi ===== */
    body.main-brown {
      background: linear-gradient(135deg, var(--brown1), var(--brown2));
      color: #fff;
      padding: 20px;
      display:flex;
      justify-content:center;
    }

    .app-wrap{
      width:100%;
      max-width:1200px;
    }

    h1{ color:#f5e0c3; margin:0 0 16px 0; }

    .main-layout {
      display:flex;
      justify-content:center;
      align-items:flex-start;
      gap:20px;
      width:100%;
      flex-wrap:wrap;
    }

    form, .produk-list {
      background: rgba(255,248,240,0.08);
      padding:20px;
      border-radius:10px;
      backdrop-filter: blur(5px);
      color:#fff;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      border:1px solid rgba(255,255,255,0.06);
    }

    form { flex:1; min-width:320px; max-width:450px; }
    .produk-list { flex:1.3; min-width:350px; max-width:700px; }

    label{ display:block; margin-top:10px; font-weight:500; color:#fcebd2; }
    input, textarea, select {
      width:100%;
      padding:8px;
      margin-top:5px;
      border:none;
      border-radius:5px;
      font-size:1em;
      background:#f5e0c3;
      color:#4b2e2e;
    }
    textarea{ resize:vertical; }

    button { margin-top:15px; padding:10px 20px; border:none; border-radius:8px; cursor:pointer; font-size:1em; background:var(--accent); color:#3e2723; font-weight:600; transition:0.3s; }
    button:hover{ transform:scale(1.03); }

    .produk-item {
      text-align:left;
      margin-bottom:12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: rgba(255,255,255,0.06);
      border-radius:8px;
      padding:8px;
    }

    .produk-item img{
      width:70px; height:70px; object-fit:cover; border-radius:8px; border:1px solid rgba(255,255,255,0.12); flex-shrink:0;
    }

    .produk-info{ display:flex; align-items:center; gap:10px; flex-grow:1; }
    .produk-btn{ background:#8d6e63; color:#fff; flex-grow:1; text-align:left; padding:10px; border-radius:6px; border:none; cursor:pointer; }
    .produk-btn:hover{ background:#a1887f; }

    .aksi{ display:flex; gap:6px; }
    .aksi button{ margin-top:0; padding:6px 10px; font-size:0.9em; border-radius:6px; }
    .btn-edit{ background:#81c784; color:#2e7d32; }
    .btn-hapus{ background:#e57373; color:#fff; }

    .notif{ text-align:center; margin-top:10px; font-weight:600; color:#ffe0b2; min-height:20px; }

    @media (max-width:800px){
      .main-layout{ flex-direction:column; }
    }

    /* ===== Halaman Detail Premium (tema gelap modern seperti template kedua) ===== */
    /* Page hidden by default */
    .detail-premium {
      display:none;
      min-height:100vh;
      padding:40px 20px;
      background: linear-gradient(180deg,#071029 0%,#071827 60%);
      color:#e6eef8;
    }

    .container-prem { max-width:1100px; margin:0 auto; }
    header.hero { display:flex; gap:20px; align-items:center; }
    .img-hero{ width:140px; height:140px; border-radius:10px; object-fit:cover; box-shadow:0 8px 30px rgba(0,0,0,0.6); border:2px solid rgba(255,255,255,0.03); }
    .badge { background: rgba(255,255,255,0.03); padding:6px 10px; border-radius:999px; color:#94a3b8; font-size:13px; display:inline-block; }
    h1.pm-title { margin:0; font-size:22px; color:#fff; }
    .sub { color:#94a3b8; margin-top:6px; }

    .grid { display:grid; grid-template-columns:1fr 360px; gap:20px; margin-top:22px; align-items:start; }
    .card { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:18px; border-radius:12px; box-shadow:0 6px 18px rgba(2,6,23,0.6); color:inherit; }
    .card h3{ margin:0 0 12px 0; color:#fff; }
    dl { display:grid; grid-template-columns:140px 1fr; gap:8px 16px; color:#e6eef8; }
    dt { color:#94a3b8; font-size:13px; }
    dd { margin:0; }

    .taste-list { display:flex; gap:8px; flex-wrap:wrap; margin-top:6px; }
    .pill { background: rgba(255,255,255,0.03); padding:6px 10px; border-radius:999px; font-size:13px; color:#e6eef8; }

    footer.pm-foot { margin-top:18px; color:#94a3b8; font-size:13px; text-align:center; }

    .charts { display:grid; grid-template-columns:1fr 1fr; gap:14px; margin-top:8px; }
    @media (max-width:900px){ .grid{ grid-template-columns:1fr; } .charts{ grid-template-columns:1fr; } }

    .back-prem { background:#081018; color:#e6eef8; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; margin-bottom:14px; }

    /* small helpers */
    .muted { color:#94a3b8; }
    .meta-row { display:flex; gap:12px; flex-wrap:wrap; margin-top:10px; }
  </style>
</head>
<body class="main-brown">

  <!-- ===== Halaman Utama: Form + Daftar Produk (tema cokelat) ===== -->
  <div class="app-wrap" id="appMain">
    <h1>☕ Manajemen Produk Kopi</h1>

    <div class="main-layout">
      <!-- Form Input -->
      <form id="formProduk">
        <input type="hidden" id="editIndex" value="-1">

        <label for="nama">Nama Produk:</label>
        <input type="text" id="nama" name="nama" placeholder="Contoh: Gayo Arabica" required>

        <label for="jenis">Jenis Kopi:</label>
        <input type="text" id="jenis" name="jenis" placeholder="Contoh: Green Coffee Grade 1 TP" required>

        <label for="asal">Asal Kopi:</label>
        <input type="text" id="asal" name="asal" placeholder="Contoh: Toraja, Sulawesi Selatan" required>

        <label for="harga">Harga (Rp):</label>
        <input type="number" id="harga" name="harga" min="0" placeholder="Contoh: 100000" required>

        <label for="aroma">Karakteristik Aroma:</label>
        <input type="text" id="aroma" name="aroma" placeholder="Contoh: Floral, Fruity, Nutty" required>

        <label for="rasa">Karakteristik Rasa:</label>
        <input type="text" id="rasa" name="rasa" placeholder="Contoh: Cokelat, Caramel, Citrus" required>

        <label for="keasaman">Tingkat Keasaman:</label>
        <select id="keasaman" name="keasaman" required>
          <option value="">-- Pilih --</option>
          <option>Rendah</option>
          <option>Sedang</option>
          <option>Tinggi</option>
        </select>

        <label for="body">Body (Kekentalan):</label>
        <select id="body" name="body" required>
          <option value="">-- Pilih --</option>
          <option>Light</option>
          <option>Medium</option>
          <option>Full</option>
        </select>

<label for="grade">Grade:</label>
<input type="text" id="grade" placeholder="Contoh: Specialty" />

<label for="moisture">Kadar Air (Moisture):</label>
<input type="text" id="moisture" placeholder="Contoh: 12.5%" />

<label for="defect">Defect Value:</label>
<input type="text" id="defect" placeholder="Contoh: 5" />

<label for="screen">Screen Size:</label>
<input type="text" id="screen" placeholder="Contoh: 17/18" />


        <label for="deskripsi">Deskripsi Produk:</label>
        <textarea id="deskripsi" name="deskripsi" rows="3" required></textarea>

        <label for="gambar">Gambar Produk:</label>
        <input type="file" id="gambar" name="gambar" accept="image/*">

        <button type="submit" id="btnSimpan">Simpan Produk</button>
        <div class="notif" id="notifMsg"></div>
      </form>

      <!-- Daftar Produk -->
      <div class="produk-list" id="produkList">
        <h2>Daftar Produk Kopi</h2>
        <p id="kosongMsg">Belum ada produk yang disimpan.</p>
        <div id="listContainer"></div>
      </div>
    </div>
  </div>

  <!-- ===== Halaman Detail Premium (semua produk akan pakai halaman ini) ===== -->
  <div class="detail-premium" id="pageDetail">
    <div class="container-prem">
      <button class="back-prem" id="btnKembali">← Kembali ke Daftar Produk</button>

      <header class="hero">
        <img id="detailImgHero" class="img-hero" src="" alt="Gambar Produk">
        <div>
          <div class="badge" id="detailBadge">Single Origin • Arabica</div>
          <h1 class="pm-title" id="detailNama">Nama Produk</h1>
          <div class="sub" id="detailSub">Subjudul / ringkasan singkat</div>

          <div class="meta-row">
            <div class="pill" id="pillAsal"></div>
            <div class="pill" id="pillHarga"></div>
            <div class="pill" id="pillJenis"></div>
          </div>
        </div>
      </header>

      <div class="grid">
        <main>
          <section class="card">
            <h3>Deskripsi</h3>
            <p id="detailRingkasan" class="muted">Deskripsi tentang produk — diisi dari form.</p>
            <hr style="opacity:0.06;margin:14px 0">

            <div style="display:flex;gap:14px;align-items:flex-start;flex-wrap:wrap">
              <div style="flex:1;min-width:240px">
                <h3>Profil Cita Rasa</h3>
                <div class="taste-list" id="tastePills">
                  <!-- dynamic pills -->
                </div>
              </div>


              <div style="flex:1;min-width:240px;display:none;">
  <h3>Asal & Ketinggian</h3>
  <dl id="dlOrigin">
    <dt>Asal</dt><dd id="dlAsal">—</dd>
    <dt>Ketinggian</dt><dd id="dlHeight">—</dd>
    <dt>Varietas</dt><dd id="dlVarietas">—</dd>
    <dt>Proses</dt><dd id="dlProses">—</dd>
  </dl>
</div>

<div style="flex:1;min-width:240px">
  <h3>Spesifikasi</h3>
  <dl id="dlQuality">
    <dt>Grade</dt><dd id="dlGrade">—</dd>
    <dt>Kadar Air (Moisture)</dt><dd id="dlMoisture">—</dd>
    <dt>Defects</dt><dd id="dlDefect">—</dd>
    <dt>Ukuran (Screen Size)</dt><dd id="dlScreen">—</dd>
  </dl>
</div>



            
            <ul style="margin:0 0 0 18px;color:#94a3b8" id="rekomendasiList">
              <!-- dynamic -->
            </ul>

            
          </section>

          <section class="card" style="margin-top:14px">
            <h3>Spesifikasi</h3>
            <dl>
              <dt>Grade</dt><dd id="techGrade">Specialty / Premium</dd>
              <dt>Kadar Air (Moisture)</dt><dd id="techMoist">10–12%</dd>
              <dt>Defects</dt><dd id="techDefects">Low (after sorting)</dd>
              <dt>Ukuran (Screen Size)</dt><dd id="techScreen">15-18</dd>
            </dl>
            
          </section>

          <section class="card" style="margin-top:14px">
            <h3>Visualisasi Profil Rasa</h3>
            <div class="charts">
              <div>
                <canvas id="radarTaste" width="400" height="300"></canvas>
              </div>
              <div>
                <canvas id="barRoast" width="400" height="300"></canvas>
              </div>
            </div>
          </section>

        </main>

        <aside>
  <div class="card">
    <h3>Ringkasan Cepat</h3>
    <dl>
      <dt>Nama</dt><dd id="asideNama">—</dd>
      <dt>Asal</dt><dd id="asideAsal">—</dd>
      <dt>Harga/kg</dt><dd id="asideHarga">—</dd>
    </dl>

    <!-- Tempat QR dan tombol download -->
    <div id="qrContainer" style="margin-top:16px; text-align:center;"></div>
    <div id="downloadContainer" style="margin-top:10px; text-align:center;"></div>
  </div>

  <div class="card" style="margin-top:14px">
    <h3>Keyword & Tag</h3>
    <div style="display:flex;gap:8px;flex-wrap:wrap" id="tagList"></div>
  </div>
</aside>

<!-- Tambahkan library QRCode.js di bagian <head> jika belum -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>


         

      <footer class="pm-foot">Informasi ini adalah deskriptif. Data teknis dan rekomendasi dihasilkan otomatis dari input produk.</footer>
    </div>
  </div>

  <script>
    /* ===== Helper: localStorage getters/setters ===== */
    function getProduk() {
      const data = localStorage.getItem('produkKopiList');
      return data ? JSON.parse(data) : [];
    }
    function setProduk(data) {
      localStorage.setItem('produkKopiList', JSON.stringify(data));
    }

    /* ===== Elements ===== */
    const form = document.getElementById('formProduk');
    const produkList = document.getElementById('listContainer');
    const kosongMsg = document.getElementById('kosongMsg');
    const notifMsg = document.getElementById('notifMsg');
    const editIndex = document.getElementById('editIndex');

    // main containers
    const appMain = document.getElementById('appMain');
    const pageDetail = document.getElementById('pageDetail');
    const bodyEl = document.body;

    // detail elements
    const detailNama = document.getElementById('detailNama');
    const detailSub = document.getElementById('detailSub');
    const detailImgHero = document.getElementById('detailImgHero');
    const pillAsal = document.getElementById('pillAsal');
    const pillHarga = document.getElementById('pillHarga');
    const pillJenis = document.getElementById('pillJenis');
    const tastePills = document.getElementById('tastePills');
    const rekomendasiList = document.getElementById('rekomendasiList');
    const detailRingkasan = document.getElementById('detailRingkasan');
    const asideNama = document.getElementById('asideNama');
    const asideAsal = document.getElementById('asideAsal');
    const asideHarga = document.getElementById('asideHarga');
    const tagList = document.getElementById('tagList');
    const btnKembali = document.getElementById('btnKembali');
    const btnContact = document.getElementById('btnContact');


    // chart references
    let radarChart = null;
    let barChart = null;

    /* ===== Utility: convert descriptors to numeric scores (0-10) ===== */
    function mapKeasamanToScore(text) {
      const t = (text||'').toLowerCase();
      if (t.includes('tinggi') || t.includes('high')) return 8;
      if (t.includes('sedang') || t.includes('medium')) return 5;
      if (t.includes('rendah') || t.includes('low')) return 2;
      // fallback: if numeric provided
      const n = parseFloat(text);
      if (!isNaN(n)) return Math.min(10, Math.max(0, Math.round(n)));
      return 5;
    }

    function mapBodyToScore(text) {
      const t = (text||'').toLowerCase();
      if (t.includes('full') || t.includes('penuh') ) return 9;
      if (t.includes('medium')) return 6;
      if (t.includes('light') || t.includes('ringan')) return 3;
      const n = parseFloat(text);
      if (!isNaN(n)) return Math.min(10, Math.max(0, Math.round(n)));
      return 5;
    }

    // Aroma & rasa: analyze keywords to derive aroma score, sweetness, aftertaste
    function analyzeAromaRasa(aromaText, rasaText) {
      const aroma = (aromaText||'').toLowerCase();
      const rasa = (rasaText||'').toLowerCase();

      // aroma score: presence of rich aroma keywords increases score
      let aromaScore = 5;
      const aromaBoost = ['floral','fruity','nutty','chocolate','cocoa','caramel','herbal','spice','spicy','citrus','vanilla','berry','berry'];
      aromaBoost.forEach(k => { if (aroma.includes(k)) aromaScore += 1; if (rasa.includes(k)) aromaScore += 0.6; });

      aromaScore = Math.min(10, Math.max(0, Math.round(aromaScore)));

      // sweetness: look for sweet keywords
      let sweetness = 4;
      const sweetWords = ['caramel','honey','sweet','sugar','chocolate','cocoa','vanilla','molasses','brown sugar','toffee','maple','fruit','fruity','berry'];
      sweetWords.forEach(k => { if (rasa.includes(k) || aroma.includes(k)) sweetness += 1; });

      // aftertaste: long/short, presence of 'long','clean','lingering'
      let aftertaste = 5;
      if (rasa.includes('long') || rasa.includes('panjang') || aroma.includes('long') || aroma.includes('panjang')) aftertaste = 8;
      if (rasa.includes('short') || rasa.includes('pendek')) aftertaste = 3;
      // presence of 'earth','tobacco','smok' reduce sweetness but increase aftertaste uniqueness
      if (rasa.includes('earth') || rasa.includes('earthy') || rasa.includes('tobacco') || rasa.includes('smok') || rasa.includes('smoke')) {
        sweetness = Math.max(0, sweetness - 1);
        aftertaste = Math.min(9, aftertaste + 1);
      }

      sweetness = Math.min(10, Math.max(0, Math.round(sweetness)));
      aftertaste = Math.min(10, Math.max(0, Math.round(aftertaste)));

      return { aromaScore, sweetness, aftertaste };
    }

    // Roast suitability (bar chart) — compute 0-100 for Light, Medium, Medium-Dark, Dark
    function computeRoastSuitability(bodyScore, acidityScore) {
      // naive rules:
      // - High body favors Medium-Dark / Dark
      // - High acidity favors Light / Medium
      // Blend scores:
      const light = Math.max(0, Math.round((10 - bodyScore) * 8 + acidityScore * 3));
      const medium = Math.max(0, Math.round((10 - Math.abs(bodyScore - 6)) * 6 + acidityScore * 2));
      const medDark = Math.max(0, Math.round(bodyScore * 7 - acidityScore * 1.5));
      const dark = Math.max(0, Math.round(bodyScore * 6 + (10 - acidityScore) * 2));

      // normalize to 0-100 while keeping relative weight
      const arr = [light, medium, medDark, dark];
      const maxVal = Math.max(...arr, 1);
      const norm = arr.map(v => Math.round((v / maxVal) * 100));
      return norm;
    }

    /* ===== Render daftar produk ===== */
    function renderProduk() {
      const produk = getProduk();
      produkList.innerHTML = '';
      if (produk.length === 0) {
        kosongMsg.style.display = 'block';
      } else {
        kosongMsg.style.display = 'none';
      }

      produk.forEach((item, index) => {
        const div = document.createElement('div');
        div.classList.add('produk-item');
        const imgSrc = item.gambar || '';
        div.innerHTML = `
          <img src="${imgSrc}" alt="${escapeHtml(item.nama)}">
          <div class="produk-info">
            <button class="produk-btn" data-index="${index}">${escapeHtml(item.nama)} (${escapeHtml(item.jenis)})</button>
          </div>
          <div class="aksi">
            <button class="btn-edit" data-index="${index}">Edit</button>
            <button class="btn-hapus" data-index="${index}">Hapus</button>
          </div>
        `;
        produkList.appendChild(div);
      });

      document.querySelectorAll('.produk-btn').forEach(btn =>
        btn.addEventListener('click', () => tampilkanDetail(btn.dataset.index))
      );

      document.querySelectorAll('.btn-edit').forEach(btn =>
        btn.addEventListener('click', () => editProduk(btn.dataset.index))
      );

      document.querySelectorAll('.btn-hapus').forEach(btn =>
        btn.addEventListener('click', () => hapusProduk(btn.dataset.index))
      );
    }

    /* ===== Escape simple helper (prevent broken attributes) ===== */
    function escapeHtml(str){
      if (!str) return '';
      return String(str).replace(/[&<>"']/g, function (m) {
        return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m];
      });
    }

    /* ===== Tampilkan halaman detail premium untuk produk idx ===== */
    function tampilkanDetail(idx) {
      const produk = getProduk()[idx];
      if (!produk) return;

      // Fill basic fields
      detailNama.textContent = produk.nama || '—';
      detailSub.textContent = `${produk.jenis || ''} • ${produk.asal || ''}`;
      detailImgHero.src = produk.gambar || 'https://images.unsplash.com/photo-1509042239860-f550ce710b93?q=80&w=800&auto=format&fit=crop&crop=faces';
      pillAsal.textContent = produk.asal || '—';
      pillHarga.textContent = produk.harga ? `Rp ${Number(produk.harga).toLocaleString('id')}` : 'Rp —';
      pillJenis.textContent = produk.jenis || '—';
      detailRingkasan.textContent = produk.deskripsi || '—';
      dlAsal.textContent = produk.asal || '—';
      dlHeight.textContent = produk.ketinggian || '—';
      dlVarietas.textContent = produk.varietas || '—';
      dlProses.textContent = produk.proses || '—';
document.getElementById('techGrade').textContent = produk.grade || '—';
document.getElementById('techMoist').textContent = produk.moisture || '—';
document.getElementById('techDefects').textContent = produk.defect || '—';
     asideNama.textContent = produk.nama || '—';
      asideAsal.textContent = produk.asal || '—';
      asideHarga.textContent = produk.harga ? `Rp ${Number(produk.harga).toLocaleString('id')}` : '—';
      // tags
      tagList.innerHTML = '';
      const tags = [produk.jenis, produk.asal, 'Product'];
      tags.forEach(t => {
        if (t) {
          const sp = document.createElement('span');
          sp.className = 'pill';
          sp.textContent = t;
          tagList.appendChild(sp);
        }
      });


// isi data Grade & Kualitas
dlGrade.textContent = produk.grade || '—';
dlMoisture.textContent = produk.moisture || '—';
dlDefect.textContent = produk.defect || '—';
dlScreen.textContent = produk.screen || '—';


      // taste pills
      tastePills.innerHTML = '';
      const pills = [
        `Body: ${produk.body || '-'}`,
        `Keasaman: ${produk.keasaman || '-'}`,
        `Aroma: ${produk.aroma || '-'}`,
        `Rasa: ${produk.rasa || '-'}`,
      ];
      pills.forEach(p => {
        const el = document.createElement('span');
        el.className = 'pill';
        el.textContent = p;
        tastePills.appendChild(el);
      });

      // rekomendasi dynamic (simple)
      rekomendasiList.innerHTML = '';
      const recs = generateRecommendations(produk);
      recs.forEach(r => {
        const li = document.createElement('li');
        li.textContent = r;
        rekomendasiList.appendChild(li);
      });

      // Chart values: compute scores
      const acidityScore = mapKeasamanToScore(produk.keasaman);
      const bodyScore = mapBodyToScore(produk.body);
      const { aromaScore, sweetness, aftertaste } = analyzeAromaRasa(produk.aroma, produk.rasa);

      // Setup radar chart dataset
      const radarData = [sweetness, acidityScore, bodyScore, aromaScore, aftertaste];

      // Setup bar chart
      const roastVals = computeRoastSuitability(bodyScore, acidityScore); // [light, medium, medDark, dark]

      // Render / update charts
      renderRadar(radarData);
      renderBar(roastVals);


// ===== QR Code otomatis =====
const qrContainer = document.getElementById("qrContainer");
const downloadContainer = document.getElementById("downloadContainer");
qrContainer.innerHTML = "";
downloadContainer.innerHTML = "";

// Buat URL berbasis nama produk (contoh: https://kopi.id/produk/gayo-arabica)
const namaSlug = produk.nama.trim().toLowerCase().replace(/\s+/g, "-").replace(/[^a-z0-9\-]/g, "");
const productURL = `https://kopi.id/produk/${namaSlug}`;

// Generate QR
const qrCode = new QRCode(qrContainer, {
  text: productURL,
  width: 160,
  height: 160,
  colorDark: "#000000",
  colorLight: "#ffffff",
  correctLevel: QRCode.CorrectLevel.H
});

// Tambahkan tombol download QR
const btnDownloadQR = document.createElement("button");
btnDownloadQR.textContent = "📥 Unduh QR Produk";
btnDownloadQR.style.marginTop = "10px";
btnDownloadQR.style.background = "#d7b899";
btnDownloadQR.style.color = "#3e2723";
btnDownloadQR.style.border = "none";
btnDownloadQR.style.padding = "8px 12px";
btnDownloadQR.style.borderRadius = "8px";
btnDownloadQR.style.cursor = "pointer";
btnDownloadQR.onclick = () => {
  const img = qrContainer.querySelector("img") || qrContainer.querySelector("canvas");
  if (img) {
    const a = document.createElement("a");
    a.href = img.src || img.toDataURL("image/png");
    a.download = `${namaSlug}-qr.png`;
    a.click();
  }
};
downloadContainer.appendChild(btnDownloadQR);


      // Show premium page, hide main
      appMain.style.display = 'none';
      pageDetail.style.display = 'block';
      bodyEl.classList.remove('main-brown');
      bodyEl.style.background = ''; // premium page uses its own background via .detail-premium
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    /* ===== Chart rendering ===== */
    function renderRadar(values) {
      const ctx = document.getElementById('radarTaste').getContext('2d');
      if (radarChart) radarChart.destroy();
      radarChart = new Chart(ctx, {
        type: 'radar',
        data: {
          labels: ['Sweetness','Acidity','Body','Aroma','Aftertaste'],
          datasets: [{
            label: 'Profil (0-10)',
            data: values,
            fill: true,
            backgroundColor: 'rgba(199,123,0,0.18)',
            borderColor: 'rgba(199,123,0,0.9)',
            pointBackgroundColor: 'rgba(199,123,0,0.9)'
          }]
        },
        options: {
          scales: { r: { beginAtZero: true, max:10, grid: {color:'rgba(255,255,255,0.04)'}, angleLines:{color:'rgba(255,255,255,0.03)'} } },
          plugins: { legend: { display:false } },
          responsive:true,
          maintainAspectRatio:false
        }
      });
    }

    function renderBar(vals) {
      const ctx = document.getElementById('barRoast').getContext('2d');
      if (barChart) barChart.destroy();
      barChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Light','Medium','Medium-Dark','Dark'],
          datasets: [{
            label: 'Sesuai (0-100)',
            data: vals,
            borderRadius:6,
            backgroundColor: 'rgba(199,123,0,0.9)'
          }]
        },
        options: { indexAxis:'x', plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true,max:100}} , responsive:true, maintainAspectRatio:false}
      });
    }

    /* ===== Generate simple recommendations based on scores ===== */
    function generateRecommendations(prod) {
      const recs = [];
      const acidityScore = mapKeasamanToScore(prod.keasaman);
      const bodyScore = mapBodyToScore(prod.body);
      

      return recs;
    }

    /* ===== Edit, Hapus, dan Simpan Produk ===== */
    function editProduk(index) {
      const produk = getProduk()[index];
      if (!produk) return;
      form.nama.value = produk.nama || '';
      form.jenis.value = produk.jenis || '';
      form.asal.value = produk.asal || '';
      form.harga.value = produk.harga || '';
      form.deskripsi.value = produk.deskripsi || '';
      form.aroma.value = produk.aroma || '';
      form.rasa.value = produk.rasa || '';
      form.keasaman.value = produk.keasaman || '';
      form.body.value = produk.body || '';
      // Note: cannot prefill file input for security — keep existing gambar
      editIndex.value = index;
      notifMsg.textContent = "✏️ Mode edit aktif — simpan untuk memperbarui produk.";
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function hapusProduk(index) {
      if (!confirm('Yakin ingin menghapus produk ini?')) return;
      const produk = getProduk();
      produk.splice(index, 1);
      setProduk(produk);
      renderProduk();
      notifMsg.textContent = '🗑️ Produk dihapus.';
      setTimeout(()=> notifMsg.textContent = '', 2500);
    }

    form.addEventListener('submit', e => {
  e.preventDefault();
  const file = document.getElementById('gambar').files[0];
  const reader = new FileReader();

  reader.onloadend = () => {
    const produk = getProduk();
    const idx = Number(editIndex.value);

    const dataBaru = {
      nama: form.nama.value.trim(),
      jenis: form.jenis.value.trim(),
      asal: form.asal.value.trim(),
      harga: form.harga.value.trim(),
      aroma: form.aroma.value.trim(),
      rasa: form.rasa.value.trim(),
      keasaman: form.keasaman.value.trim(),
      body: form.body.value.trim(),
      grade: document.getElementById("grade").value.trim(),
      moisture: document.getElementById("moisture").value.trim(),
      defect: document.getElementById("defect").value.trim(),
      screen: document.getElementById("screen").value.trim(),
      deskripsi: form.deskripsi.value.trim(),
      gambar: reader.result || '', // base64 data URL
    };

    if (idx >= 0) {
      produk[idx] = dataBaru;
      notifMsg.textContent = "✅ Produk berhasil diperbarui.";
    } else {
      produk.push(dataBaru);
      notifMsg.textContent = "☕ Produk baru disimpan.";
    }

    setProduk(produk);
    renderProduk();
    form.reset();
    editIndex.value = -1;
    setTimeout(() => notifMsg.textContent = '', 2500);
  };

  if (file) reader.readAsDataURL(file);
  else reader.onloadend(); // panggil langsung jika tidak ada gambar baru
});


    /* ===== Kembali ke daftar dari detail ===== */
    btnKembali.addEventListener('click', () => {
      pageDetail.style.display = 'none';
      appMain.style.display = 'block';
      bodyEl.classList.add('main-brown');
      bodyEl.style.background = ''; // reset
      // destroy charts to free memory
      if (radarChart){ radarChart.destroy(); radarChart = null; }
      if (barChart){ barChart.destroy(); barChart = null; }
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    /* ===== Init ===== */
    window.addEventListener('load', () => {
      // default editIndex to -1
      editIndex.value = -1;
      renderProduk();
    });

    /* ===== Additional: btnContact action (simple) ===== */
    btnContact.addEventListener('click', (ev) => {
      ev.preventDefault();
      alert('Contoh: hubungi supplier lokal untuk informasi harga & batch (demo).');
    });

renderProduk();

// Tombol kembali di halaman detail
btnKembali.addEventListener('click', () => {
  pageDetail.style.display = 'none';
  appMain.style.display = 'block';
  bodyEl.classList.add('main-brown');
  window.scrollTo({ top: 0, behavior: 'smooth' });
});


    /* ===== Optional: provide some sample data if none exists (comment out if tidak mau) ===== */
    (function maybeSeed(){
      const p = getProduk();
      if (p.length === 0) {
        // small seed example (uncomment to seed)
        // const sample = [{
        //   nama: 'Sumatra Mandheling',
        //   jenis: 'Arabica',
        //   asal: 'Sumatra Utara',
        //   harga: '120000',
        //   aroma: 'Herbal, Cocoa, Earthy',
        //   rasa: 'Cokelat, Tembakau, Caramel',
        //   keasaman: 'Rendah',
        //   body: 'Full',
        //   deskripsi: 'Kopi khas Sumatra dengan body penuh dan catatan rempah.',
        //   gambar: ''
        // }];
        // setProduk(sample);
        // renderProduk();
      }
    })();

  </script>
</body>
</html>
